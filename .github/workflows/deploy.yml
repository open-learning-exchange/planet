name: Manual Deploy

on:
  push:
    branches:
      - deploy
  workflow_dispatch:
    inputs:
      hostname:
        description: 'Server hostname Eg. "planet.dev.ole.org"'
        required: true
        default: 'planet.dev.ole.org'

env:
  DOCKER_ORG: treehouses
  DOCKER_REPO_TAG: planet-tags
  DOCKER_REPO: planet
  
jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: sshagent
        uses: webfactory/ssh-agent@v0.5.2
        with:
          ssh-private-key: ${{ secrets.SSHKEY }}

      - name: deploy
        run: |
          if [[ "${{ github.event.inputs.hostname }}" == "" ]]; then
            SERVER_HOST="planet.dev.ole.org"  
          else
            SERVER_HOST="${{ github.event.inputs.hostname }}"
          fi
          echo "$SERVER_HOST"
          PLANET_VERSION=$(jq '.version' package.json | sed -e 's/^"//' -e 's/"$//')
          PLANET_REPO="$DOCKER_ORG/$DOCKER_REPO_TAG:$PLANET_VERSION-$GITHUB_REF_NAME-${GITHUB_SHA::8}"
          DBINIT_REPO="$DOCKER_ORG/$DOCKER_REPO_TAG:$PLANET_VERSION-$GITHUB_REF_NAME-${GITHUB_SHA::8}"
          docker pull $PLANET_REPO
          docker pull $DBINIT_REPO
          docker tag $PLANET_REPO "$DOCKER_ORG/$DOCKER_REPO:local1"
          docker tag $DBINIT_REPO "$DOCKER_ORG/$DOCKER_REPO:db-init-local1"
          #branch="${GITHUB_REF#refs/heads/}"
          echo "The branched that was pushed is $branch"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$SERVER_HOST ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFqXBJPFe+pH3L57o1ildAxHssG4lpkloTcw3Wbs64c7bL8M6hR0rre4ufpCKboVLn4trJqbKOPWtFgBJHsgqXA=" > ~/.ssh/known_hosts
          ssh root@$SERVER_HOST <<EOF
          cd /srv/planet/
          hostname
          pwd
          ls -la
          docker images
          EOF
